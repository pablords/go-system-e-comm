.PHONY: help generate-all generate-payment sync-all sync-payment sync-orders clean

# Diret√≥rios dos servi√ßos
PAYMENTS_DIR := ../payments
ORDERS_DIR := ../orders

# Diret√≥rios de destino dos protos
PAYMENTS_PROTO_DIR := $(PAYMENTS_DIR)/proto
ORDERS_PROTO_DIR := $(ORDERS_DIR)/proto

help:
	@echo "üìã Comandos dispon√≠veis:"
	@echo ""
	@echo "  make generate-all     - Gera c√≥digo Go para todos os protos"
	@echo "  make generate-payment - Gera c√≥digo Go apenas para payment"
	@echo ""
	@echo "  make sync-all         - Sincroniza protos para todos os servi√ßos"
	@echo "  make sync-payment     - Sincroniza payment.proto para payments e orders"
	@echo ""
	@echo "  make clean            - Remove arquivos gerados (.pb.go)"
	@echo ""

# Gerar c√≥digo Go a partir dos protos
generate-all: generate-payment

generate-payment:
	@echo "üî® Gerando c√≥digo Go para payment.proto..."
	@protoc --go_out=$(PAYMENTS_PROTO_DIR) --go_opt=paths=source_relative \
		--go-grpc_out=$(PAYMENTS_PROTO_DIR) --go-grpc_opt=paths=source_relative \
		payment/payment.proto
	@echo "‚úÖ C√≥digo gerado em $(PAYMENTS_PROTO_DIR)"

# Sincronizar protos para os servi√ßos
sync-all: sync-payment

sync-payment:
	@echo "üì¶ Sincronizando payment.proto..."
	@mkdir -p $(PAYMENTS_PROTO_DIR)
	@mkdir -p $(ORDERS_PROTO_DIR)
	@cp -v payment/payment.proto $(PAYMENTS_PROTO_DIR)/
	@cp -v payment/payment.proto $(ORDERS_PROTO_DIR)/
	@echo "‚úÖ payment.proto sincronizado para payments e orders"
	@echo ""
	@echo "üî® Gerando c√≥digo nos servi√ßos..."
	@cd $(PAYMENTS_DIR) && make proto || true
	@cd $(ORDERS_DIR) && make proto || true
	@echo "‚úÖ Sincroniza√ß√£o completa!"

# Limpar arquivos gerados
clean:
	@echo "üßπ Limpando arquivos gerados..."
	@find $(PAYMENTS_PROTO_DIR) -name "*.pb.go" -delete 2>/dev/null || true
	@find $(ORDERS_PROTO_DIR) -name "*.pb.go" -delete 2>/dev/null || true
	@echo "‚úÖ Arquivos .pb.go removidos"

# Validar que os protos est√£o sincronizados
validate:
	@echo "üîç Validando sincroniza√ß√£o dos protos..."
	@if ! diff -q payment/payment.proto $(PAYMENTS_PROTO_DIR)/payment.proto > /dev/null 2>&1; then \
		echo "‚ùå payment.proto est√° dessincronizado no payments service!"; \
		exit 1; \
	fi
	@if ! diff -q payment/payment.proto $(ORDERS_PROTO_DIR)/payment.proto > /dev/null 2>&1; then \
		echo "‚ùå payment.proto est√° dessincronizado no orders service!"; \
		exit 1; \
	fi
	@echo "‚úÖ Todos os protos est√£o sincronizados"
